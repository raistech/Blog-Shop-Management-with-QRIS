<% const pageTitle = 'Checkout - ' + product.name; %>
<%- include('partials/header') %>

<div class="container" style="margin-top: 2rem; margin-bottom: 4rem;">
    <div style="max-width: 800px; margin: 0 auto;">
        <h1 style="text-align: center; margin-bottom: 2rem;">
            <i class="fas fa-shopping-cart"></i>
            Checkout
        </h1>
        
        <% if (!order) { %>
            <!-- Step 1: Customer Information -->
            <div class="card">
                <h3><i class="fas fa-box"></i> Detail Produk</h3>
                <div style="display: flex; align-items: center; gap: 1.5rem; margin: 1.5rem 0; padding: 1.5rem; background: var(--bg-secondary); border-radius: var(--radius-lg);">
                    <% if (product.image_url) { %>
                        <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-md);">
                    <% } else { %>
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                            <i class="fas fa-box"></i>
                        </div>
                    <% } %>
                    
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0;"><%= product.name %></h4>
                        <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;"><%= product.description ? product.description.substring(0, 100) + '...' : '' %></p>
                    </div>
                    
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">
                            Rp <%= product.price.toLocaleString('id-ID') %>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            Stok: <%= product.stock %>
                        </div>
                    </div>
                </div>
                
                <form method="POST" action="/checkout/<%= product.id %>">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <h3 style="margin-top: 2rem;"><i class="fas fa-user"></i> Informasi Pembeli</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Isi minimal salah satu kontak untuk menerima invoice dan link download</p>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>
                            Email *
                        </label>
                        <input type="email" name="customer_email" class="form-input" placeholder="your@email.com" required>
                        <p class="form-help">Link download akan dikirim ke email ini</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fab fa-whatsapp"></i>
                            WhatsApp (Opsional)
                        </label>
                        <input type="tel" name="customer_whatsapp" class="form-input" placeholder="08123456789 atau 628123456789">
                        <div class="alert alert-info" style="margin-top: 0.5rem; padding: 0.75rem; font-size: 0.875rem;">
                            <i class="fas fa-info-circle"></i>
                            <strong>Untuk mendapatkan notifikasi WhatsApp:</strong>
                            <ol style="margin: 0.5rem 0 0 1.2rem; padding: 0;">
                                <li>Simpan nomor bot: <strong><span id="botNumber">Loading...</span></strong></li>
                                <li>Kirim pesan "Halo" ke bot WhatsApp kami</li>
                                <li>Setelah checkout, notifikasi akan otomatis terkirim!</li>
                            </ol>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.8rem;">
                                ðŸ’¡ Jika tidak chat ke bot, notifikasi hanya ke email saja
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fab fa-telegram"></i>
                            Telegram (Opsional)
                        </label>
                        <input type="text" name="customer_telegram" class="form-input" placeholder="@username">
                        <p class="form-help">Username Telegram Anda (opsional)</p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Penting:</strong> Pastikan data kontak Anda benar. Invoice dan link download akan dikirim ke kontak yang Anda berikan.
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-arrow-right"></i>
                        Lanjut ke Pembayaran
                    </button>
                </form>
            </div>
        <% } else { %>
            <!-- Step 2: Payment -->
            <div class="card">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2.5rem; color: white; box-shadow: var(--shadow-glow);">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h2>Pembayaran QRIS</h2>
                    <p style="color: var(--text-secondary);">Scan QR Code di bawah untuk melakukan pembayaran</p>
                </div>
                
                <!-- Invoice Info -->
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Invoice Number:</span>
                        <strong style="font-family: monospace;"><%= order.invoice_number %></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Produk:</span>
                        <strong><%= order.product_name %></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Harga:</span>
                        <span>Rp <%= order.product_price.toLocaleString('id-ID') %></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Kode Unik:</span>
                        <span style="color: var(--warning);">+ Rp <%= order.unique_code.toLocaleString('id-ID') %></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; font-size: 1.25rem;">
                        <strong>Total Pembayaran:</strong>
                        <strong style="color: var(--success); font-size: 1.75rem;">Rp <%= order.total_amount.toLocaleString('id-ID') %></strong>
                    </div>
                </div>
                
                <div class="alert alert-warning payment-instruction">
                    <div class="payment-instruction-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="payment-instruction-content">
                        <p><strong>PENTING:</strong> Bayar <strong>TEPAT</strong> sesuai nominal </p>
                        <p class="payment-amount">Rp <%= order.total_amount.toLocaleString('id-ID') %></p>
                        <p> (termasuk kode unik). </p>
                        <p>Sistem akan otomatis mendeteksi pembayaran Anda.</p>
                    </div>
                </div>
                
                <!-- QR Code -->
                <div style="text-align: center; margin: 2rem 0;">
                    <div id="qrcode" style="display: inline-block; padding: 1.5rem; background: white; border-radius: var(--radius-xl); box-shadow: var(--shadow-lg);"></div>
                    <p style="margin-top: 1rem; color: var(--text-muted);">
                        <i class="fas fa-mobile-alt"></i>
                        Scan dengan aplikasi e-wallet Anda (DANA, OVO, GoPay, ShopeePay, dll)
                    </p>
                </div>
                
                <!-- Status -->
                <div id="paymentStatus" style="text-align: center; padding: 1.5rem; background: rgba(96, 165, 250, 0.1); border-radius: var(--radius-lg); border-left: 4px solid var(--info);">
                    <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                    <p style="margin: 0; font-weight: 600; color: var(--info);">
                        <i class="fas fa-sync fa-spin"></i>
                        Menunggu pembayaran...
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--text-muted);">
                        Sistem akan otomatis mendeteksi pembayaran Anda
                    </p>
                </div>
                
                <div class="alert alert-info" style="margin-top: 2rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Catatan:</strong> Setelah pembayaran berhasil, link download akan dikirim ke email Anda dalam 1-3 menit. Simpan nomor invoice untuk keperluan support.
                </div>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <a href="/shop" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Batalkan Pesanan
                    </a>
                </div>
            </div>
        <% } %>
    </div>
</div>

<% if (order) { %>
    <!-- Include QRCode.js library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <script>
        // Generate QR Code
        const qrcode = new QRCode(document.getElementById('qrcode'), {
            text: '<%= order.qris_string %>',
            width: 280,
            height: 280,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });
        
        // Auto-polling untuk cek status pembayaran
        const invoiceNumber = '<%= order.invoice_number %>';
        let pollingInterval;
        let pollCount = 0;
        const maxPolls = 600; // 30 menit (600 * 3 detik)
        
        function checkPaymentStatus() {
            fetch(`/api/order-status/${invoiceNumber}`)
                .then(response => response.json())
                .then(data => {
                    pollCount++;
                    
                    if (data.status === 'paid') {
                        // Pembayaran berhasil!
                        clearInterval(pollingInterval);
                        
                        const statusDiv = document.getElementById('paymentStatus');
                        statusDiv.style.background = 'rgba(74, 222, 128, 0.1)';
                        statusDiv.style.borderColor = 'var(--success)';
                        statusDiv.innerHTML = `
                            <div style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p style="margin: 0; font-weight: 700; color: var(--success); font-size: 1.25rem;">
                                Pembayaran Berhasil!
                            </p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">
                                Redirecting...
                            </p>
                        `;
                        
                        // Redirect ke thank you page
                        setTimeout(() => {
                            window.location.href = `/thank-you/${invoiceNumber}`;
                        }, 2000);
                    } else if (pollCount >= maxPolls) {
                        // Timeout
                        clearInterval(pollingInterval);
                        
                        const statusDiv = document.getElementById('paymentStatus');
                        statusDiv.style.background = 'rgba(251, 191, 36, 0.1)';
                        statusDiv.style.borderColor = 'var(--warning)';
                        statusDiv.innerHTML = `
                            <p style="margin: 0; font-weight: 600; color: var(--warning);">
                                <i class="fas fa-clock"></i>
                                Polling timeout. Refresh halaman untuk cek status terbaru.
                            </p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error checking payment status:', error);
                    pollCount++; // Still count polls even on error
                    // Continue polling - network issue might be temporary
                });
        }
        
        // Start polling setiap 3 detik
        pollingInterval = setInterval(checkPaymentStatus, 3000);
        
        // Cek sekali saat load
        checkPaymentStatus();
        
        // Stop polling saat user meninggalkan halaman
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
<% } else { %>
    <script>
        // Load WhatsApp bot number from settings
        fetch('/api/bot-info')
            .then(response => response.json())
            .then(data => {
                const botNumberSpan = document.getElementById('botNumber');
                if (data.whatsapp_phone_number) {
                    botNumberSpan.textContent = data.whatsapp_phone_number;
                } else {
                    botNumberSpan.textContent = '(Bot belum dikonfigurasi)';
                }
            })
            .catch(error => {
                console.error('Error loading bot info:', error);
                document.getElementById('botNumber').textContent = '(Tidak tersedia)';
            });
    </script>
<% } %>

<%- include('partials/footer') %>
