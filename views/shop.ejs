<% const pageTitle = 'Shop'; %>
<%- include('partials/header') %>

<div class="container" style="margin-top: 2rem; margin-bottom: 4rem;">
    <!-- Page Header -->
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1>Katalog Produk</h1>
        <p style="color: var(--text-secondary);">Temukan produk digital terbaik untuk kebutuhan Anda</p>
    </div>
    
    <!-- Search & Filter Bar -->
    <div class="card" style="margin-bottom: 2rem;">
        <form method="GET" action="/shop" id="shopFilterForm">
            <div class="flex" style="gap: 1rem; flex-wrap: wrap; align-items: center;">
                <!-- Search Input -->
                <div class="form-group" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            name="search" 
                            id="searchInput"
                            class="form-input" 
                            placeholder="Cari produk..." 
                            value="<%= searchQuery %>"
                            style="padding-left: 2.5rem;"
                        >
                        <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    </div>
                </div>
                
                <!-- Category Filter -->
                <div class="form-group" style="min-width: 200px; margin-bottom: 0;">
                    <select name="category" id="categoryFilter" class="form-select" onchange="document.getElementById('shopFilterForm').submit()">
                        <option value="">Semua Kategori</option>
                        <% categories.forEach(cat => { %>
                            <option value="<%= cat.slug %>" <%= selectedCategory === cat.slug ? 'selected' : '' %>>
                                <%= cat.icon %> <%= cat.name %>
                            </option>
                        <% }); %>
                    </select>
                </div>
                
                <!-- Filter Button -->
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i>
                    Filter
                </button>
                
                <!-- Reset Button -->
                <% if (searchQuery || selectedCategory) { %>
                    <a href="/shop" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Reset
                    </a>
                <% } %>
            </div>
        </form>
    </div>
    
    <!-- Active Filters Display -->
    <% if (searchQuery || selectedCategory) { %>
        <div style="margin-bottom: 2rem;">
            <div class="flex" style="gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <span style="color: var(--text-secondary); font-weight: 600;">Filter aktif:</span>
                
                <% if (searchQuery) { %>
                    <span class="badge" style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-full); display: inline-flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-search"></i>
                        "<%= searchQuery %>"
                        <a href="/shop?<%= selectedCategory ? 'category=' + selectedCategory : '' %>" style="color: white; margin-left: 0.25rem;">
                            <i class="fas fa-times"></i>
                        </a>
                    </span>
                <% } %>
                
                <% if (selectedCategory) { %>
                    <% const activeCat = categories.find(c => c.slug === selectedCategory); %>
                    <% if (activeCat) { %>
                        <span class="badge" style="background: var(--secondary); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-full); display: inline-flex; align-items: center; gap: 0.5rem;">
                            <%= activeCat.icon %> <%= activeCat.name %>
                            <a href="/shop?<%= searchQuery ? 'search=' + searchQuery : '' %>" style="color: white; margin-left: 0.25rem;">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    <% } %>
                <% } %>
            </div>
        </div>
    <% } %>
    
    <!-- Products Grid -->
    <div id="productsContainer">
    <% if (products && products.length > 0) { %>
        <div style="margin-bottom: 2rem;" id="productsCount">
            <p style="color: var(--text-secondary);">
                <i class="fas fa-box"></i>
                Menampilkan <%= products.length %> produk
            </p>
        </div>
        
        <div class="grid grid-3" id="productsGrid">
            <% products.forEach(product => { %>
                <div class="card product-card">
                    <!-- Product Image -->
                    <% if (product.image_url) { %>
                        <a href="/product/<%= product.slug %>" style="display: block; margin: -2rem -2rem 1.5rem -2rem;">
                            <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
                        </a>
                    <% } else { %>
                        <div style="width: calc(100% + 4rem); height: 200px; margin: -2rem -2rem 1.5rem -2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
                            <i class="fas fa-box"></i>
                        </div>
                    <% } %>
                    
                    <!-- Digital Badge -->
                    <% if (product.is_digital) { %>
                        <span class="product-badge">
                            <i class="fas fa-download"></i> Digital
                        </span>
                    <% } %>
                    
                    <div class="product-card-content">
                        <!-- Category -->
                        <div class="product-category">
                            <i class="fas fa-tag"></i>
                            <%= product.category_name || 'Uncategorized' %>
                        </div>
                        
                        <!-- Product Name -->
                        <h3 class="product-name"><%= product.name %></h3>
                        
                        <!-- Description -->
                        <% if (product.description) { %>
                            <p class="product-description"><%= product.description %></p>
                        <% } %>
                        
                        <!-- Price -->
                        <div class="product-price">
                            Rp <%= product.price.toLocaleString('id-ID') %>
                        </div>
                        
                        <!-- Stock -->
                        <div class="product-stock <%= product.stock <= 5 && product.stock > 0 ? 'low-stock' : '' %> <%= product.stock === 0 ? 'out-of-stock' : '' %>">
                            <i class="fas fa-box"></i>
                            <% if (product.stock === 0) { %>
                                Stok Habis
                            <% } else if (product.stock <= 5) { %>
                                Stok Terbatas: <%= product.stock %>
                            <% } else { %>
                                Stok: <%= product.stock %>
                            <% } %>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="product-card-actions" style="display: flex; gap: 0.5rem;">
                            <a href="/product/<%= product.slug %>" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-eye"></i>
                                Detail
                            </a>
                            
                            <% if (product.stock > 0) { %>
                                <a href="/checkout/<%= product.id %>" class="btn btn-outline" style="flex: 1;">
                                    <i class="fas fa-shopping-cart"></i>
                                    Beli
                                </a>
                            <% } else { %>
                                <button class="btn btn-secondary" disabled style="flex: 1;">
                                    <i class="fas fa-times"></i>
                                    Habis
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <!-- No products initially (for dynamic loading) -->
        <div id="noProductsMessage"></div>
    <% } %>
    </div>
    
    <!-- Loading Spinner -->
    <div id="searchLoading" style="display: none; text-align: center; padding: 3rem;">
        <div class="loading-spinner"></div>
        <p style="margin-top: 1rem; color: var(--text-secondary);">Mencari produk...</p>
    </div>
    
    <% if (false) { %>
        <!-- No Products Found -->
        <div class="card" style="text-align: center; padding: 4rem 2rem;">
            <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1rem;">
                <i class="fas fa-inbox"></i>
            </div>
            <h3 style="margin-bottom: 1rem;">Tidak Ada Produk Ditemukan</h3>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                <% if (searchQuery || selectedCategory) { %>
                    Coba ubah filter atau kata kunci pencarian Anda
                <% } else { %>
                    Belum ada produk tersedia saat ini
                <% } %>
            </p>
            <% if (searchQuery || selectedCategory) { %>
                <a href="/shop" class="btn btn-primary">
                    <i class="fas fa-redo"></i>
                    Lihat Semua Produk
                </a>
            <% } %>
        </div>
    <% } %>
    
    <!-- Category Cards (Quick Filter) -->
    <% if (!selectedCategory && categories && categories.length > 0) { %>
        <div style="margin-top: 4rem;">
            <h2 style="text-align: center; margin-bottom: 2rem;">Belanja Berdasarkan Kategori</h2>
            
            <div class="grid grid-4">
                <% categories.forEach(cat => { %>
                    <a href="/shop?category=<%= cat.slug %>" class="card" style="text-align: center; text-decoration: none; transition: all 0.3s ease;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">
                            <%= cat.icon %>
                        </div>
                        <h4 style="margin-bottom: 0.5rem;"><%= cat.name %></h4>
                        <% if (cat.description) { %>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0;">
                                <%= cat.description %>
                            </p>
                        <% } %>
                    </a>
                <% }); %>
            </div>
        </div>
    <% } %>
</div>

<!-- Real-time Search Script -->
<script>
    // Real-time search with AJAX
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const productsContainer = document.getElementById('productsContainer');
    const searchLoading = document.getElementById('searchLoading');
    let searchTimeout;
    
    // Debounced search function
    function performSearch() {
        const searchQuery = searchInput.value.trim();
        const categorySlug = categoryFilter.value;
        
        // Show loading
        searchLoading.style.display = 'block';
        productsContainer.style.opacity = '0.5';
        
        // Build query params
        const params = new URLSearchParams();
        if (searchQuery) params.append('search', searchQuery);
        if (categorySlug) params.append('category', categorySlug);
        
        // Fetch products
        fetch(`/api/products/search?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                renderProducts(data.products, data.total, searchQuery, categorySlug);
                searchLoading.style.display = 'none';
                productsContainer.style.opacity = '1';
            })
            .catch(error => {
                console.error('Search error:', error);
                searchLoading.style.display = 'none';
                productsContainer.style.opacity = '1';
                if (window.RSAStore && window.RSAStore.showNotification) {
                    window.RSAStore.showNotification('Gagal mencari produk', 'error');
                }
            });
    }
    
    // Render products to DOM
    function renderProducts(products, total, searchQuery, categorySlug) {
        let html = '';
        
        if (products.length > 0) {
            // Products count
            html += `
                <div style="margin-bottom: 2rem;" id="productsCount">
                    <p style="color: var(--text-secondary);">
                        <i class="fas fa-box"></i>
                        Menampilkan ${total} produk
                    </p>
                </div>
                <div class="grid grid-3" id="productsGrid">
            `;
            
            // Product cards
            products.forEach(product => {
                const hasImage = product.image_url;
                const isOutOfStock = product.stock === 0;
                const isLowStock = product.stock <= 5 && product.stock > 0;
                
                html += `
                    <div class="card product-card">
                        ${hasImage ? `
                            <a href="/product/${product.slug}" style="display: block; margin: -2rem -2rem 1.5rem -2rem;">
                                <img src="${product.image_url}" alt="${product.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
                            </a>
                        ` : `
                            <div style="width: calc(100% + 4rem); height: 200px; margin: -2rem -2rem 1.5rem -2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
                                <i class="fas fa-box"></i>
                            </div>
                        `}
                        
                        ${product.is_digital ? `
                            <span class="product-badge">
                                <i class="fas fa-download"></i> Digital
                            </span>
                        ` : ''}
                        
                        <div class="product-card-content">
                            <div class="product-category">
                                <i class="fas fa-tag"></i>
                                ${product.category_name || 'Uncategorized'}
                            </div>
                            
                            <h3 class="product-name">${product.name}</h3>
                            
                            ${product.description ? `
                                <p class="product-description">${product.description}</p>
                            ` : ''}
                            
                            <div class="product-price">
                                Rp ${parseInt(product.price).toLocaleString('id-ID')}
                            </div>
                            
                            <div class="product-stock ${isLowStock ? 'low-stock' : ''} ${isOutOfStock ? 'out-of-stock' : ''}">
                                <i class="fas fa-box"></i>
                                ${isOutOfStock ? 'Stok Habis' : isLowStock ? `Stok Terbatas: ${product.stock}` : `Stok: ${product.stock}`}
                            </div>
                            
                            <div class="product-card-actions" style="display: flex; gap: 0.5rem;">
                                <a href="/product/${product.slug}" class="btn btn-primary" style="flex: 1;">
                                    <i class="fas fa-eye"></i>
                                    Detail
                                </a>
                                
                                ${!isOutOfStock ? `
                                    <a href="/checkout/${product.id}" class="btn btn-outline" style="flex: 1;">
                                        <i class="fas fa-shopping-cart"></i>
                                        Beli
                                    </a>
                                ` : `
                                    <button class="btn btn-secondary" disabled style="flex: 1;">
                                        <i class="fas fa-times"></i>
                                        Habis
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        } else {
            // No products found
            html = `
                <div class="card" style="text-align: center; padding: 4rem 2rem;">
                    <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1rem;">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3 style="margin-bottom: 1rem;">Tidak Ada Produk Ditemukan</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        ${searchQuery || categorySlug ? 'Coba ubah filter atau kata kunci pencarian Anda' : 'Belum ada produk tersedia saat ini'}
                    </p>
                    ${searchQuery || categorySlug ? `
                        <a href="/shop" class="btn btn-primary">
                            <i class="fas fa-redo"></i>
                            Lihat Semua Produk
                        </a>
                    ` : ''}
                </div>
            `;
        }
        
        productsContainer.innerHTML = html;
    }
    
    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch();
            }, 500); // 500ms debounce
        });
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener('change', () => {
            performSearch();
        });
    }
    
    // Prevent form submission (we use AJAX now)
    const shopFilterForm = document.getElementById('shopFilterForm');
    if (shopFilterForm) {
        shopFilterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            performSearch();
        });
    }
</script>

<%- include('partials/footer') %>
