<% const pageTitle = 'Invoice Recovery'; %>
<%- include('partials/header') %>

<div class="container" style="margin-top: 3rem; margin-bottom: 4rem;">
    <div style="max-width: 600px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: white; box-shadow: var(--shadow-glow);">
                <i class="fas fa-receipt"></i>
            </div>
            <h1>Invoice Recovery</h1>
            <p style="color: var(--text-secondary); font-size: 1.125rem;">
                Request link download baru untuk pesanan Anda
            </p>
        </div>
        
        <% if (error) { %>
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <%= error %>
            </div>
        <% } %>
        
        <% if (order) { %>
            <!-- Recovery Success -->
            <div class="card">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>Verifikasi Berhasil!</strong> Link download baru telah digenerate.
                </div>
                
                <h3><i class="fas fa-info-circle"></i> Detail Pesanan</h3>
                
                <div style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Invoice:</span>
                        <strong style="font-family: monospace;"><%= order.invoice_number %></strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Produk:</span>
                        <strong><%= order.product_name %></strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-muted);">Total:</span>
                        <strong>Rp <%= order.total_amount.toLocaleString('id-ID') %></strong>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0;">
                        <span style="color: var(--text-muted);">Status:</span>
                        <span class="badge" style="background: var(--success); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-full);">
                            <i class="fas fa-check-circle"></i> Paid
                        </span>
                    </div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(102, 126, 234, 0.1); border-radius: var(--radius-lg); text-align: center;">
                    <h4 style="margin-top: 0;"><i class="fas fa-download"></i> Link Download</h4>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Link berlaku selama 60 menit</p>
                    
                    <a href="<%= order.download_url %>" class="btn btn-primary btn-lg" target="_blank" style="width: 100%;">
                        <i class="fas fa-download"></i>
                        Download Sekarang
                    </a>
                    
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                        <i class="fas fa-envelope"></i>
                        Link juga telah dikirim ke email Anda
                    </p>
                </div>
                
                <div class="alert alert-warning" style="margin-top: 2rem;">
                    <i class="fas fa-clock"></i>
                    <strong>Catatan:</strong> Jika link kedaluwarsa, Anda bisa request link baru kapan saja dengan nomor invoice yang sama.
                </div>
            </div>
        <% } else { %>
            <!-- Recovery Form -->
            <div class="card">
                <form method="POST" action="/recover">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <h3><i class="fas fa-search"></i> Cari Pesanan Anda</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Masukkan nomor invoice dan salah satu kontak untuk verifikasi
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-receipt"></i>
                            Nomor Invoice <span style="color: var(--error);">*</span>
                        </label>
                        <input 
                            type="text" 
                            name="invoice_number" 
                            class="form-input" 
                            placeholder="INV-20240107-123456" 
                            required
                            style="font-family: monospace; text-transform: uppercase;"
                        >
                        <p class="form-help">Format: INV-YYYYMMDD-XXXXXX</p>
                    </div>
                    
                    <div style="margin: 2rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-lg); border-left: 3px solid var(--info);">
                        <p style="margin: 0; color: var(--text-muted); font-size: 0.875rem;">
                            <i class="fas fa-info-circle"></i>
                            Isi minimal satu kontak di bawah untuk verifikasi (sesuai dengan data saat checkout)
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>
                            Email
                        </label>
                        <input 
                            type="email" 
                            name="customer_email" 
                            class="form-input" 
                            placeholder="your@email.com"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fab fa-whatsapp"></i>
                            WhatsApp
                        </label>
                        <input 
                            type="tel" 
                            name="customer_whatsapp" 
                            class="form-input" 
                            placeholder="6281234567890"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fab fa-telegram"></i>
                            Telegram Username
                        </label>
                        <input 
                            type="text" 
                            name="customer_telegram" 
                            class="form-input" 
                            placeholder="@username"
                        >
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-search"></i>
                        Cari & Request Link Download
                    </button>
                </form>
                
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                    <h4><i class="fas fa-question-circle"></i> Bantuan</h4>
                    <ul style="color: var(--text-secondary); line-height: 1.8;">
                        <li>Nomor invoice dikirim ke email saat checkout</li>
                        <li>Data kontak harus sesuai dengan yang Anda gunakan saat checkout</li>
                        <li>Link download baru akan dikirim ke email Anda</li>
                        <li>Jika masih bermasalah, hubungi customer support kami</li>
                    </ul>
                </div>
            </div>
        <% } %>
        
        <!-- Contact Support -->
        <div style="text-align: center; margin-top: 3rem;">
            <p style="color: var(--text-muted); margin-bottom: 1rem;">Tidak bisa menemukan invoice Anda?</p>
            <a href="/contact" class="btn btn-secondary">
                <i class="fas fa-headset"></i>
                Hubungi Customer Support
            </a>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
